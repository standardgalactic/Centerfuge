# AUTOGENERATED by xylomorphic_blender_gen.py
import bpy, math, mathutils, random
from math import sin, cos, pi

bpy.ops.wm.read_factory_settings(use_empty=True)
scene = bpy.context.scene
scene.frame_start = 1
scene.frame_end = 1

scene.render.engine = "CYCLES"
scene.render.resolution_x = 1280
scene.render.resolution_y = 720
scene.render.resolution_percentage = 100
if scene.render.engine == "CYCLES":
    scene.cycles.samples = 64

# Lighting and camera
if not scene.world:
    scene.world = bpy.data.worlds.new("World")
scene.world.use_nodes = True
bg = scene.world.node_tree.nodes["Background"]
bg.inputs[0].default_value = (0.02,0.03,0.015,1)
bg.inputs[1].default_value = 1.0

# Sunlight
sun = bpy.data.lights.new("Sun","SUN")
sun.energy = 5
sun_obj = bpy.data.objects.new("Sun",sun)
bpy.context.collection.objects.link(sun_obj)
sun_obj.location = (8,-8,10)
sun_obj.rotation_euler = (math.radians(60),0,math.radians(35))

# Camera
cam = bpy.data.cameras.new("Camera")
cam_obj = bpy.data.objects.new("Camera",cam)
bpy.context.collection.objects.link(cam_obj)
scene.camera = cam_obj
cam_obj.location = (10,-12,8)
cam_obj.rotation_euler = (math.radians(55),0,math.radians(40))

# Materials
def mat_emissive(name,col=(1,1,1,1),strength=5):
    m=bpy.data.materials.new(name); m.use_nodes=True
    nt=m.node_tree
    for n in list(nt.nodes): nt.nodes.remove(n)
    e=nt.nodes.new("ShaderNodeEmission"); e.inputs[0].default_value=col; e.inputs[1].default_value=strength
    o=nt.nodes.new("ShaderNodeOutputMaterial"); nt.links.new(e.outputs[0],o.inputs[0]); return m

def mat_pbr(name,base=(.5,.5,.5,1),rough=.6,metal=.0):
    m=bpy.data.materials.new(name); m.use_nodes=True
    p=m.node_tree.nodes["Principled BSDF"]
    p.inputs["Base Color"].default_value=base
    p.inputs["Roughness"].default_value=rough
    p.inputs["Metallic"].default_value=metal
    return m

# Scene: Xylomorphic Cityscape
# A panoramic bio-architectural skyline where cellulose towers merge with luminous vascular roots.

wood_tower = mat_pbr("TowerWood",(0.28,0.18,0.12,1),0.7,0)
glass_sap  = mat_emissive("GlassSap",(0.6,0.9,0.8,1),20)
root_mat   = mat_pbr("Root",(0.12,0.08,0.06,1),0.8,0)
mist_mat   = mat_emissive("Mist",(0.6,0.7,0.9,1),2)

random.seed(2025)
for i in range(14):
    x = random.uniform(-10,10)
    y = random.uniform(-10,10)
    h = random.uniform(6,18)
    r = random.uniform(0.5,1.0)
    bpy.ops.mesh.primitive_cylinder_add(radius=r, depth=h, location=(x,y,h/2))
    t=bpy.context.active_object
    t.data.materials.append(wood_tower)
    # luminous cap
    bpy.ops.mesh.primitive_uv_sphere_add(radius=r*0.6, location=(x,y,h+0.5))
    s=bpy.context.active_object; s.data.materials.append(glass_sap)
    # vascular roots branching
    for j in range(random.randint(2,5)):
        a = random.uniform(0,2*pi)
        l = random.uniform(2,5)
        x2=x+l*cos(a); y2=y+l*sin(a)
        bpy.ops.curve.primitive_bezier_curve_add()
        c=bpy.context.active_object
        bp=c.data.splines[0].bezier_points
        bp[0].co=(x,y,0); bp[1].co=(x2,y2,-2)
        c.data.bevel_depth=0.05; c.data.materials.append(root_mat)

# Ground / water reflection plane
bpy.ops.mesh.primitive_plane_add(size=60,location=(0,0,0))
g=bpy.context.active_object; g.data.materials.append(mat_pbr("Ground",(0.05,0.06,0.07,1),0.9,0))

# Floating mist layers
for k in range(6):
    bpy.ops.mesh.primitive_plane_add(size=60,location=(0,0,2.5+k*3))
    m=bpy.context.active_object
    m.data.materials.append(mist_mat)
    m.hide_render=True  # only to scatter subtle light

# Camera setup for panorama
scene.camera.location = (22,-22,14)
scene.camera.rotation_euler = (math.radians(65),0,math.radians(45))

blend=r"out/blends/xylomorphic_cityscape-20251103T171235Z.blend"; png=r"out/renders/xylomorphic_cityscape-20251103T171235Z.png"
import os; os.makedirs(os.path.dirname(blend),exist_ok=True); os.makedirs(os.path.dirname(png),exist_ok=True)
scene.render.filepath = png
bpy.ops.render.render(write_still=True)
bpy.ops.wm.save_mainfile(filepath=blend)
